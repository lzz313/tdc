<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>测试数据收集系统</title>
	<style type="text/css">
		body{margin:0;padding:0;font-size:14px;font-family:Tahoma,SimSun; height:100%}
		div {display: block;margin:0 auto}
		p{margin:0 auto;padding:0;}
		
		.container{width:1318px;}
		
		.page_head{width:1318px;height: 30px}
		.page_left{width:363px;float:left;border:1px solid #969696;min-height: 600px;}
		.page_envi{width:700px;float:left;border:1px solid #000;height: 25px;}
		.envi_edit{display: none;width:630px;}
		.page_center{width:700px;float:left;border:1px solid #000;min-height: 600px;}
		.page_right{width:248px;float:right;border:1px solid #969696;}
		
		.project_name,.project_list{width:350px;float:left;margin:2px 0 2px 3px;}
		.project_delete_link{width:30px;float:right;}
		.project_add_link{width:80px;float:right;}
		.project_list .project_name:nth-child(3n+0){background: #93C2F5}
		.project_list .project_name:nth-child(3n+1){background: #CFD39D}
		.project_list .project_name:nth-child(3n+2){background: #F7CF9E}
		.project_name p{height:25px; margin:8px 0 0 3px; border-bottom: 1px solid #969696;}
		.project_name a{margin-top:8px;}
		
		.project_name_edit,.project_name_add{width:265px;}
		.project_update_bt,.project_cancle_update_bt,.project_cancle_add_bt,.project_add_bt{width:38px;}
		.project_edit,.function_edit,.project_add,.function_add{display:none;}

		.function_name {width:325px;margin: 2px 0 2px 25px;}
		.function_name p{height:18px; margin:8px 0 0 2px; border-bottom: 1px solid #969696;}
		.function_name a{margin-top:1px;}
		.function_delete{width:32px;float:right;}
		
		.function_name_edit,.function_name_add {width:245px;}
		.function_update_bt,.function_cancle_update_bt,.function_add_bt,.function_cancle_add_bt{width:38px;}
		.function_edit,.function_add{margin-left: 20px;}
		.function_add_link{width:50px;float:right;}
		
		.tdc_list{width:700px;display:inline-block;}
		.tdc_list .tdc_item:nth-child(3n+2){background: #93C2F5}
		.tdc_list .tdc_item:nth-child(3n+0){background: #D0D3B3}
		.tdc_list .tdc_item:nth-child(3n+1){background: #F7CF9E}
		
		.tdc_add{width:700px;height:23px; border-bottom: 1px solid #000;}
		.tdc_add p{height:23px;float:left;padding-top: 3px;}
		.tdc_add input{float:right;}
		
		.tdc_item{width:690px;padding:3px 5px 3px 5px;}
		.tdc_title{width:690px;height: 20px;}
		.tdc_title p{width:450px;float: left;}
		.tdc_title_add_bt{border:1px solid #000;}
		.tdc_title_anly_bt{border:1px solid #000;}
		
		.tdc_data,.tdc_action{display: none;}
		.tdc_name_value_type_title span{margin: 0 85px 0 30px;}
		
		.select{position:absolute;margin-top:3px; display: inline-block;width: 300px;border:1px solid #969696;}
		.envi_tips {margin: 4px 0 0 3px ;width: 65px;float:left;}
		.option,.option_edit{position: relative;width: 298px;border-top:1px solid #000;z-index: 100;display: none;background-color: #fff;}
		.option_edit input{width:115px;}
		.option_edit label{font-size: 5pt;}
		/**
		filter:alpha(opacity=50);opacity:0.5;-moz-opacity: .50
		*/
	</style>
</head>
<body>
	<div class="container">
		<div class="page_head"></div>
		<div class="page_left">
			<p>项目列表<a class="project_add_link" onclick="showAddProject()">新加项目</a></p>
			<div class="project_list"></div>
		</div>
		<div class="page_envi">
			<p class="envi_tips">测试环境</p>
			<div class="select">
				<span>请选择...</span><span style="float: right;">▼</span>
			</div>
		</div>
		<div class="page_center">
			<div class="tdc_add">
				<p>测试步骤</p>
			</div>
			<div class="tdc_list"></div>
			<div id="tdc_anlysis" style="display:none;">
				地址：<input type="text" id="url" style="width: 300px"/><input type="button" id='parseUrl' value="分析页面表单"/>
				<div id="parseForm" action="">
				</div>	
			</div>
		</div>
		<div class="page_right">
			<p>接口参数</p>
		</div>
	</div>
	<script type="text/javascript" src="/js/jquery.min.js"></script>
	<script type="text/javascript" src="/js/project.module.js"></script>
	<script type="text/javascript" src="/js/testcase.js"></script>
	<script type="text/javascript">
		var editabelOptionTemplate = [
										'<div class="option" id="@{id}" value="@{value}">@{name}</div>',
										'<div class="option_edit">',
											'<input type="hidden" class="envi_ipt_id" value="@{id}"/>',
											'<input type="hidden" class="envi_ipt_pid" value="@{pid}"/>',
											'<label>地址:</label><input type="text" class="envi_ipt_val" init="输入地址..." value="@{value}"/>',
											'<label>名称:</label><input type="text" class="envi_ipt_name" init="输入名称..." value="@{name}"/>',
										'</div>'
		                              ].join('');
		function loadEnvi(pid){
			$(".select").attr("pid",pid);
			var url ="/domain/query/"+pid;
			
			var envi = $.ajax({
				url : url,
				type : "get",
				async:false,
				dataType : "json"
			});
			
			envi.done(function(data){
				if(data.code == 1){
					var domains = data.data.queryDomain;
					
					$.each(domains,function(i){
						$(".select").append(editabelOptionTemplate.format({
							id:domains[i].id,
							pid:domains[i].projectId,
							value:domains[i].domain,
							name:domains[i].name
						}));
					});
					if(domains.length == 0){
						$(".select").append(editabelOptionTemplate.format({
							id:'',
							pid:pid,
							value:'输入地址...',
							name:'输入名称...'
						}));
					}
					addOptionEvent();
				}
			});
			
			addEnviEvent();
		}
		
		function saveOrDispEnvi(){
			if($(this).is('hidden')){
				$(".select .option").each(function(){
					var val = $(this).attr("value");
					var name = $(this).html();
					
					$(this).next().children(".envi_ipt_val").val(val);
					$(this).next().children(".envi_ipt_name").val(name);
				});
			} else {
				var id = $(this).children(".envi_ipt_id").val();
				var pid = $(this).children(".envi_ipt_pid").val();
				var domain = $(this).children(".envi_ipt_val").val();
				var name = $(this).children(".envi_ipt_name").val();
				//添加delete
				var url =id?"/domain/update":"/domain/add";
				
				var init = $(this).children(".envi_ipt_val").attr("init");
				if(init == domain && !id){
					return;
				}
				
				if(init == domain && !!id){
					url = "/domain/delete/"+id;
				} 
				
				var saveEnvi = $.ajax({
					url : url,
					data:{id:id,pid:pid,name:name,domain:domain},
					type : "get",
					async:false,
					dataType : "json"
				});
				
				var obj = $(this);
				saveEnvi.done(function(data){
					obj.prev().html(name);
					obj.prev().attr("value",domain);
				});
			}
		}
		
		function addOptionEvent(){
			$(".select input[type='text']").focus(function(){
				var init = $(this).attr('init');
				if(init != $(this).val()){
					return;
				}
				
				$(this).val('');
			});
			$(".select input[type='text']").blur(function(){
				var init = $(this).attr('init');
				if($(this).val() == ''){
					$(this).val(init);
				}
			});
			$(".select .option").click(function(){
				$(".select span:first").attr("value",$(this).attr("value"));
				$(".select span:first").html($(this).html());
				$(".select .option").hide();
			});
		}
		
		function addEnviEvent(){
			var pTimeFn = null;
			$(".select span").click(function(){
				clearTimeout(pTimeFn);
				pTimeFn = setTimeout(function(){
					$(".select .option").toggle();
				},300);
			});
			$(".select span").live("dblclick",function(){
				clearTimeout(pTimeFn);
				$(".select .option_edit").toggle("normal",saveOrDispEnvi);
			});
			
			$(".option_edit:last input[type='text']").die().live("blur",function(){
				var obj = $(this).parent();
				var inputs = obj.children("input[type=text]");
				var needAppend = true;
				$.each(inputs,function(i){
					var init = $(inputs[i]).attr('init');
					if(init == $(inputs[i]).val()){
						needAppend = false;
					}
				});
				
				if(needAppend) {
					obj.parent().append(editabelOptionTemplate.format({
						id:'',
						pid:$(".select").attr("pid"),
						value:'输入地址...',
						name:'输入名称...'
					}));
					$(".option:last").html('');
					$(".option_edit:last").show();
					addOptionEvent();
				}
			});
		}
		
		$(document).ready(function(){
			loadProject();
			
			$("#parseUrl").click(function(){
				anlysis();
			});
		});
	</script>
</body>