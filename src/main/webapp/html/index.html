<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>TDC首页</title>
	<style type="text/css">
		body{margin:0;padding:0;font-size:14px;font-family:Tahoma,SimSun; height:100%}
		div {display: block;margin:0 auto}
		p{margin:0 auto;padding:0;}
		
		.container{width:1318px;}
		
		.page_head{width:1318px;height: 30px}
		.page_left{width:363px;float:left;border:1px solid #969696;min-height: 600px;}
		.page_center{width:700px;float:left;border:1px solid #000;min-height: 600px;}
		.page_right{width:248px;float:right;border:1px solid #969696;}
		
		.project_name,.project_list{width:350px;float:left;margin:5px 0 5px 3px;}
		.project_delete_link{width:30px;float:right;}
		.project_add_link{width:80px;float:right;}
		
		.project_name_edit,.project_name_add{width:265px;}
		.project_update_bt,.project_cancle_update_bt,.project_cancle_add_bt,.project_add_bt{width:38px;}
		.project_edit,.function_edit,.project_add,.function_add{display:none;}

		.function_name {width:327px;margin: 2px 0 2px 25px;}
		.function_delete{width:32px;float:right;}
		
		.function_name_edit,.function_name_add {width:245px;}
		.function_update_bt,.function_cancle_update_bt,.function_add_bt,.function_cancle_add_bt{width:38px;}
		.function_edit,.function_add{margin-left: 20px;}
		.function_add_link{width:50px;float:right;}
		
		.tdc_list{width:700px;display:inline-block;}
		
		.tdc_add{width:700px;height:23px; border-bottom: 1px solid #000;}
		.tdc_add p{height:23px;float:left;padding-top: 3px;}
		.tdc_add input{float:right;}
		
		.tdc_item{width:690px;padding:3px 5px 3px 5px;}
		.tdc_title{width:690px;height: 20px;}
		.tdc_title p{width:450px;float: left;}
		.tdc_title_add_bt{border:1px solid #000;}
		.tdc_title_anly_bt{border:1px solid #000;}
		
		.tdc_data,.tdc_action{display: none;}
		.tdc_name_value_type_title span{margin: 0 85px 0 30px;}
	</style>
</head>
<body>
	<div class="container">
		<div class="page_head">
		
		</div>
		<div class="page_left">
			<p>项目列表<a class="project_add_link" onclick="showAddProject()">新加项目</a></p>
			<div class="project_list">
				
			</div>
		</div>
		
		<div class="page_center">
			<div class="tdc_add">
				<p>测试步骤</p>
			</div>
			
			<div class="tdc_list">
				
			</div>	
		</div>
		
		<div class="page_right">
			<p>接口参数</p>
			
		</div>
	</div>
	<script type="text/javascript" src="/js/jquery.min.js"></script>
	<script type="text/javascript" src="/js/project.module.js"></script>
	<script type="text/javascript">
		var addNewTdcBtTemplate = [
									'<input type="button" fid="@{functionId}" class="tdc_title_anly_bt" value="分析"/>',
									'<input type="button" fid="@{functionId}" class="tdc_title_add_bt" value="添加"/>'
		                           ].join('');
		var tdcListTemplate = [
							'<div class="tdc_item" id="tdc_@{id}">',
								'<div class="tdc_title">',
									'<p>@{name}</p>',
									'<span style="float:right;">时间:@{create}</span>',
									'<input type="hidden" id="fid_@{id}" value="@{functionId}"/>',
									'<input type="hidden" id="status_@{id}" value="@{status}"/>',
								'</div>',
								'<div class="tdc_data" tid="@{id}">',
									'<div class="tdc_info">',
										'步骤: <input id="step_@{id}" value="@{step}" style="width:50px"/> ',
								       	'名称: <input id="name_@{id}" value="@{name}" style="width:200px"/> ',
								       	'地址: <input id="action_@{id}" value="@{url}" style="width:180px"/>',
				                   	   	'method:',
				                   		'<select id="method_@{id}" >',
				                   			'<option value="GET">GET</option>',
				                   			'<option value="POST">POST</option>',
				                   		'</select>',
				                   	'</div>',
				                   	'<div class="tdc_name_value_type_title"><span>字段名</span><span>字段值</span><span>字段类型</span></div>',
								'</div>',
								'<div class="tdc_action">',
									'<input type="button" tid="@{id}" class="tdc_save_bt" value="保存"/>',
									'<input type="button" tid="@{id}" class="tdc_delete_bt" value="删除"/>',
									'<input type="button" value="测试"/>',
								'</div>',
							'</div>' 
						   ].join('');
		
		var tdcItemDataTemplate = [
									'<div class="tdc_name_value_type" dtlId="@{j}">',
										'<span>参数</span>',
										'<input id="@{id}_eleName_@{j}" type="text" name="eleName" value="@{name}"/>',
										'<input id="@{id}_eleValue_@{j}" type="text" name="eleValue" value="@{value}"/>',
										'<input id="@{id}_eleType_@{j}" type="text" name="eleType" value="@{type}"/>',
										'<input class="tdc_name_value_delete_bt" type="button" value="删除"/>',
									'</div>'
		                           ].join('');
		
		function displayTestData(o){
			var fid = o.parent().attr("fid");
			var url = "/testcase/query/all/"+fid;
			
			$(".tdc_add input[type=button]").remove();
			$(".tdc_add").append(addNewTdcBtTemplate.format({
				functionId:fid
			}));
			
			var testcases = $.ajax({
				url : url,
				type : "get",
				async:false,
				dataType : "json"
			});
			
			testcases.done(function(data){
				if(data.code == 1){
					var testCases = data.data.testCases;
					$(".tdc_list").html('');
					$.each(testCases,function(i){
						var testCase = testCases[i];
						addTdc(testCase);
					});
					
					addTdcEvent();
				}
			});
		}
		
		function addTdc(testCase){
			$(".tdc_list").append(tdcListTemplate.format({
				id:testCase.id,
				name:testCase.name,
				step:testCase.step,
				functionId:testCase.functionId,
				url:testCase.url,
				create:testCase.create,
				status:testCase.status
			}));
			
			var elems = JSON.parse(testCase.data).elem;
			$.each(elems,function(j){
				$("#tdc_"+testCase.id+" .tdc_data").append(tdcItemDataTemplate.format({
					id:testCase.id,
					j:j,
					name:elems[j].k,
					value:elems[j].v,
					type:elems[j].t
				}));
			});
		}
		
		function addTdcEvent(){
			$(".tdc_title").die().live("click",function(){
				var o = $(this).next();
				if(o.is(":hidden")){
					o.show();
					o.next().show();
				} else {
					o.hide();
					o.next().hide();
				}
			});
			
			var j = $(".tdc_name_value_type").length;
			$(".tdc_name_value_type:last input[type=text]").die().live("blur",function(){
				var obj = $(this).parent();
				var inputs = obj.children("input[type=text]");
				var needAppend = true;
				$.each(inputs,function(i){
					if(!$(inputs[i]).val()){
						needAppend = false;
					}
				});
				
				var tid = obj.parent().attr("tid");
				if(needAppend) {
					obj.parent().append(tdcItemDataTemplate.format({
						id:tid,
						j:j,
						name:'',
						value:'',
						type:''
					}));
					addTdcDelEvent();
				}
			});
			
			$(".tdc_save_bt").click(function(){
				var btObj = $(this);
				var tid = btObj.attr("tid");
				saveTdcData(tid);
			});
			
			$(".tdc_delete_bt").click(function(){
				var btObj = $(this);
				var tid = btObj.attr("tid");
				deleteTdc(btObj,tid);
			});
			
			$(".tdc_title_add_bt").click(function(){
				var fId = $(this).attr("fid");
				var testCase={id:'',functionId:fId,name:'创建测试用例',url:'',type:'',step:'',data:'{"elem":[{"k":"","v":"","t":""}]}',create:'',status:''};
				addTdc(testCase);
				$("#tdc_"+testCase.id+" .tdc_data").show();
				$("#tdc_"+testCase.id+" .tdc_action").show();
				addTdcEvent();
			});
			
			addTdcDelEvent();
		}
		
		function saveTdcData(tid){
			var fId = $("#fid_"+tid).val();
			var name = $("#name_"+tid).val();
			var step = $("#step_"+tid).val();
			var action = $("#action_"+tid).val();
			var type = $("#method_"+tid).val();
			var status = $("#status_"+tid).val();
			var data = encapElemData(tid);
			
			var url =!tid?"/testcase/add":"/testcase/update";
			
			var testcases = $.ajax({
				url : url,
				data :{id:tid,functionId:fId,name:name,step:step,url:action,type:type,data:data,status:status},
				type : "post",
				async:false,
				dataType : "json"
			});
			
			testcases.done(function(data){
				if(data.code == 1){
					$("#tdc_"+tid+" .tdc_title span:first").html(name);
					alert("保存成功");
				}
			});
		}
		
		function addTdcDelEvent(){
			$(".tdc_name_value_delete_bt").die().live("click",(function(){
				if(!confirm("确定删除!")){
					return;
				}
				$(this).parent().remove();
			}));
		}
		
		function encapElemData(tid){
			var elemObjs = $("#tdc_"+tid+" .tdc_data .tdc_name_value_type");
			var data ={elem:''};
			var elem = [];
			var ElemObj = {'k':'','v':'','t':''};
			
			$.each(elemObjs,function(i){
				var elemObj = $(elemObjs[i]);
				var name = elemObj.children("input[name='eleName']");
				var value = elemObj.children("input[name='eleValue']");
				var type = elemObj.children("input[name='eleType']");
				if(!!name.val()&&!!value.val()&&!!type.val()){
					var elemObj = {};
					elemObj.k = name.val();
					elemObj.v = value.val();
					elemObj.t = type.val();
					elem[i] = elemObj;
				}
			});
			
			data.elem = elem;
			
			return JSON.stringify(data);
		}
		
		function deleteTdc(obj,tid){
			var url ="/testcase/delete/"+tid;
			
			var testcases = $.ajax({
				url : url,
				type : "get",
				async:false,
				dataType : "json"
			});
			
			testcases.done(function(data){
				if(data.code == 1){
					obj.parent().parent().remove();
					alert("删除成功");
				}
			});
		}
		
		$(document).ready(function(){
			loadProject();
		});
	</script>
</body>