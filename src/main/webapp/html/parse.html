<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>分析页面form表单</title>
	<style type="text/css">
		div {display: block;}
		p{margin:0;padding:0;}
		
		.container{width:100%;}
		.analysis{width:1000px;margin:0 auto;}
		
		.page_left{width:228px;float:left;}
		.page_right{width:900px;float:right;}
		
		.project_list{width:228px;float:left;}
		.project_name .project_name_edit{width:132px;}
		.project_update .project_update_cancle{width:38px;}
		.project_delete{width:50px;float:right;}
	</style>
</head>
<body>
	<div class="container">
		<div class="page_left">
			<p>项目列表</p>
			<div class="project_list">
			
			</div>
		</div>
		
		<div class="page_right">
			<div class="analysis">
				地址：<input type="text" id="url" style="width: 300px"/><a href="#" id='parseUrl'>分析</a>
			</div>
			
			
			<div id="parseForm" action="">
		
			</div>
		</div>
	</div>
	<script type="text/javascript" src="/js/jquery.min.js"></script>
	<script type="text/javascript">
		String.prototype.format = function(O){
			var s = this.replace(/\@\{(\w+)\}/g, function(t, _o){
				return O[_o]==null?'':O[_o];
			});
			return s;
		};
		
		var formTemplate = ['<p>表单名: @{formName}  ',
		                    '提交地址: <input id="action_@{i}" value="@{formAction}" style="width:300px"/>',
		                    'method:<input id="method_@{i}" value="@{method}" style="width:30px"/> </p>'].join('');
		var inputTemplate = [
						'<input id="@{fIdx}_eleName_@{i}" type="text" name="@{fIdx}_eleName_@{i}" value="@{name}"/>',
						'<input id="@{fIdx}_eleValue_@{i}" type="text" name="@{fIdx}_eleValue_@{i}" value="@{value}"/>',
						'<input id="@{fIdx}_eleType_@{i}" type="text" name="@{fIdx}_eleType_@{i}" value="@{type}"/>',
						'<input id="@{fIdx}_delete_@{i}" type="button" value="删除" onclick="del(@{fIdx},@{i})"/><br/>'
						].join('');
		
		var buttonTemplate = [
		                      '<input id="save_@{i}" type="button" value="保存"/>',
		                      '<input id="test_@{i}" type="button" value="测试" onclick="test(@{i})"/>'
		                      ].join(''); 
		
		
		function del(fIdx,i){
			$("#"+fIdx+"_eleName_"+i).remove();
			$("#"+fIdx+"_eleValue_"+i).remove();
			$("#"+fIdx+"_eleType_"+i).remove();
			$("#"+fIdx+"_delete_"+i).next().remove();
			$("#"+fIdx+"_delete_"+i).remove();
		}
		
		
		function getActionWithHost(action,url){
			var actionUrl = action;
			if(action.toLowerCase().indexOf('http') !=0){
				host = url.split('/')[2];
				actionUrl = 'http://'+host+action;
			}
			
			return actionUrl
		}
		
		function pushForm(forms){
			$.each(forms,function(i){
				$("#parseForm").append(formTemplate.format({
												i:i,
												formName:forms[i].formName,
												formAction:getActionWithHost(forms[i].formAction,$("#url").val()),
												method:forms[i].method})
									   );
				
				var inputs = forms[i].inputs;
				$.each(inputs,function(j){
					$("#parseForm").append(inputTemplate.format({
						i:j,
						fIdx:i,
						name:inputs[j].name,
						value:inputs[j].value,
						type:inputs[j].type
					}));
				});
				
				$("#parseForm").append(buttonTemplate.format({
					i:i})
		   		);
			});
		}
		
		function parse(){
			var url = "/parse/form?url="+$("#url").val();
			$.getJSON(url,function(data){
				$("#parseForm").html('');
				if(data.code == 1){
					var forms = data.data.parse.formList;
					if(forms.length == 0){
						$("#parseForm").append("页面没有找到表单");
					} else {
						pushForm(forms);
					}
				} else {
					$("#parseForm").append(data.msg);
				}
			});	
		}
		
		function formData(fIdx){
			var eleNm = fIdx+"_eleName_";
			var eleVal = fIdx+"_eleName_";
			
			var args = new Object();
			$('input[id^='+eleNm+']').each(function(){
				idx = $(this).attr("id").split('_')[2];
				var key = $("#"+eleNm+idx).val();
				var value = $("#"+eleVal+idx).val()
				
				args[key]=value;
			});
			
			return JSON.stringify(args);
		}
		
		function test(i){
			var testAction = $.ajax({
				url : "/parse/test",
				type : "post",
				async : false,
				data : {
					formData:formData(i),
					url:$("#action_"+i).val(),
					method:$("#method_"+i).val()
				},
				dataType : "json"
			});
			testAction.done(function(data) {
				NewWindow = window.open("","_blank");
				NewWindow.document.write(data.data.content);
			});
		}
		
		
		var projectTemplate = [
								'<div class="project_name" id=@{id} >',
									'<a class="project_delete" pid=@{id} onclick="deleteProject($(this))">删除</a>',
									'<p>@{name}</p>',
								'</div>' 
							   ].join('');
		var editProjectTemplate = [
									'<input type="text" class="project_name_edit" value="@{value}"/>',
									'<input type="button" class="project_update" value="更新"/>',
									'<input type="button" class="project_update_cancle" value="取消"/>'
		                           ].join('');
		function loadProject(){
			var url = "/project/query";
			var projects = $.ajax({
				url : url,
				type : "get",
				async:false,
				dataType : "json"
			});
			
			projects.done(function(data){
				if(data.code == 1){
					var projects = data.data.projects
					$.each(projects,function(i){
						$(".project_list").append(projectTemplate.format({name:projects[i].name,id:projects[i].id}))
					});
				}
			})
		}
		
		function editProject(){
			alert('test');
		}
		
		function deleteProject(obj){
			var delProject = $.ajax({
				url : "/project/delete/"+obj.attr("pid"),
				type : "POST",
				async:false,
				dataType : "json"
			});
			
			delProject.done(function(data){
				if(data.code == 1){
					obj.prev().hide();
					obj.hide();
				}else{
					alert(data.msg);
				}
			});
		}
		
		$(document).ready(function(){
			loadProject();
			$("#parseUrl").click(function(){
				parse();
			});	
			
			$("div.project_name >p").click(function(){
				$(this).parent().children().each(function(){$(this).hide()});
				$(this).parent().append(editProjectTemplate.format({
					value:$(this).parent().children("p").html()
				}));
			});
			
			$(".project_update").click(function(){
				$("div.project_name");
			})
		});
	</script>
</body>